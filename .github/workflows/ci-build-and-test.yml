# CI: Build and Test
#
# This workflow runs on every push to any branch and on all pull requests.
# It serves as the quality gate for all code changes by:
# - Building all modules (SDK, adapters, demo app)
# - Running all unit tests
# - Publishing test results and reports
#
# Other workflows (publishing, APK builds) wait for this to pass before running.

name: CI - Build and Test

on:
  push:
    branches:
      - '**'  # Run on all branches
  pull_request:
    branches:
      - '**'  # Run on all PRs

# Required for junit-report action to create checks and annotations
permissions:
  checks: write
  pull-requests: write
  contents: read

jobs:
  build:
    name: Build and Test
    runs-on: self-hosted

    steps:
      # Check out the code
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      # Set up Java 17 with Gradle caching for faster builds
      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # Make gradlew executable (needed on some systems)
      - name: 🔧 Grant execute permission for gradlew
        run: chmod +x gradlew

      # Run tests and build all modules
      # Android library projects need explicit testDebugUnitTest task
      # Using --stacktrace for better error diagnostics
      - name: 🏗️ Run tests
        run: ./gradlew testDebugUnitTest --stacktrace

      - name: 🏗️ Build all modules
        run: ./gradlew assembleDebug --stacktrace

      # Parse test results and create summary (runs even if tests fail)
      - name: 📊 Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '**/build/test-results/**/TEST-*.xml'
          check_name: Test Results

      # Upload detailed test reports only on failure for debugging
      - name: 📦 Upload detailed test reports on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-reports-${{ github.run_number }}
          path: |
            **/build/reports/tests/
            **/build/test-results/
          retention-days: 7
